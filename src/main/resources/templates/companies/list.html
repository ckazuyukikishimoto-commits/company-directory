<!DOCTYPE html>
<html class="dark" lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>企業一覧画面</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#111418",
                    },
                    fontFamily: {
                        "display": ["Inter", "Noto Sans JP", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .group:focus-within .group-focus-within\:block {
            display: block;
        }

        .group:focus-within .group-focus-within\:opacity-100 {
            opacity: 1;
        }

        .group:focus-within .group-focus-within\:pointer-events-auto {
            pointer-events: auto;
        }
    </style>

    <!-- CSRF Meta Tags for AJAX -->
    <meta th:if="${_csrf}" name="_csrf" th:content="${_csrf.token}" />
    <meta th:if="${_csrf}" name="_csrf_header" th:content="${_csrf.headerName}" />

    <style>
        /* Toast Styles */
        #toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background-color: #1c2127;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
            min-width: 350px;
            animation: slideIn 0.3s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.hiding {
            animation: slideOut 0.3s ease-in forwards;
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }

            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .toast-undo-btn {
            color: #137fec;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s;
        }

        .toast-undo-btn:hover {
            background-color: rgba(19, 127, 236, 0.1);
        }

        .toast-close-btn {
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            margin-right: -0.5rem;
        }

        .toast-close-btn:hover {
            color: white;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark">

    <div
        class="relative flex h-screen w-full flex-col bg-background-light dark:bg-background-dark group/design-root overflow-hidden">
        <div class="flex h-full grow flex-col">
            <div class="px-4 sm:px-6 md:px-8 lg:px-10 flex flex-col h-full">
                <div class="layout-content-container flex flex-col w-full mx-auto max-w-[1400px] flex-1 h-full py-4">
                    <div class="flex flex-col flex-1 h-full">
                        <div class="flex flex-wrap justify-between items-center gap-4 pb-3">
                            <h1
                                class="text-gray-800 dark:text-white text-2xl font-bold leading-tight tracking-[-0.033em]">
                                企業一覧</h1>
                            <div class="flex flex-wrap items-center gap-2">
                                <form method="get" class="flex flex-wrap items-center gap-2">
                                    <button th:formaction="@{companies/add}"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-md h-9 px-3 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                                        <span class="material-symbols-outlined text-base">add_circle</span>
                                        <span class="truncate">新規追加</span>
                                    </button>
                                    <button th:formaction="@{/companies/batch}"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-md h-9 px-3 bg-green-600 text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors">
                                        <span class="material-symbols-outlined text-base">grid_on</span>
                                        <span class="truncate">まとめて追加</span>
                                    </button>
                                    <button th:formaction="@{/companies/import}"
                                        title="Excelファイル(.xlsx)から企業データを一括インポート"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-md h-9 px-3 bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                        <span class="material-symbols-outlined text-base">upload_file</span>
                                        <span class="truncate">Excelインポート</span>
                                    </button>
                                    <button type="button" id="toggleSelectModeBtn"
                                        title="複数の企業を選択してエクスポート"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-md h-9 px-3 bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                        <span class="material-symbols-outlined text-base">check_box</span>
                                        <span class="truncate">選択モード</span>
                                    </button>
                                    <button type="button" id="openExportModalBtn"
                                        title="企業データをExcelファイルとして出力"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-md h-9 px-3 bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                        <span class="material-symbols-outlined text-base">download</span>
                                        <span class="truncate">エクスポート</span>
                                    </button>
                                    <button th:formaction="@{companies/template}"
                                        title="インポート用のExcelテンプレートをダウンロード"
                                        class="flex min-w-[84px] cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-md h-9 px-3 bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                        <span class="material-symbols-outlined text-base">description</span>
                                        <span class="truncate">テンプレートDL</span>
                                    </button>
                                    <button th:formaction="@{companies/trash}"
                                        title="削除した企業の履歴を表示"
                                        class="flex h-10 w-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                        <span class="material-symbols-outlined text-xl">delete_history</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                        <form th:action="@{/companies}" method="get" th:object="${searchForm}">
                            <input type="hidden" name="size" th:value="${page?.size} ?: 5" />
                            <div class="flex flex-col gap-3 pb-3">
                                <div class="flex items-start gap-3">
                                    <div class="flex-1">
                                        <label class="flex flex-col min-w-40 h-10">
                                            <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                                                <div
                                                    class="text-[#9dabb9] flex bg-white dark:bg-[#283039] items-center justify-center pl-4 rounded-l-lg border border-gray-300 dark:border-[#3b4754] border-r-0">
                                                    <span class="material-symbols-outlined">search</span>
                                                </div>
                                                <input name="keyword" th:value="${searchForm?.keyword}"
                                                    class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-gray-800 dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary border-gray-300 dark:border-[#3b4754] bg-white dark:bg-[#283039] focus:border-primary/50 h-full placeholder:text-gray-400 dark:placeholder:text-[#9dabb9] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal"
                                                    placeholder="キーワード検索..." value="" />
                                            </div>
                                        </label>
                                    </div>
                                    <div class="flex-1 relative">
                                        <details
                                            class="w-full rounded-lg border border-gray-300 dark:border-[#3b4754] bg-white dark:bg-[#1c2127] group">
                                            <summary class="flex cursor-pointer items-center gap-2 px-3 h-10 list-none">
                                                <p
                                                    class="text-gray-800 dark:text-white text-sm font-medium leading-normal">
                                                    詳細検索</p>
                                                <div
                                                    class="ml-auto text-gray-600 dark:text-white group-open:rotate-180 transition-transform">
                                                    <span class="material-symbols-outlined">expand_more</span>
                                                </div>
                                            </summary>
                                            <div class="absolute top-full left-0 w-full mt-2 z-20">
                                                <div
                                                    class="border border-gray-300 dark:border-[#3b4754] p-4 bg-white dark:bg-[#1c2127] rounded-lg shadow-lg">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                        <div>
                                                            <label
                                                                class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">企業ID</label>
                                                            <input name="companyId" th:value="${searchForm?.companyId}"
                                                                class="form-input block w-full rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] text-gray-800 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-primary focus:border-primary h-9 text-sm"
                                                                placeholder="例: 0001" type="number" step="1" />
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">企業名</label>
                                                            <input name="companyName"
                                                                th:value="${searchForm?.companyName}"
                                                                class="form-input block w-full rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] text-gray-800 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-primary focus:border-primary h-9 text-sm"
                                                                placeholder="例: 株式会社未来テクノロジー" type="text" />
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">住所</label>
                                                            <input name="address" th:value="${searchForm?.address}"
                                                                class="form-input block w-full rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] text-gray-800 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-primary focus:border-primary h-9 text-sm"
                                                                placeholder="例: 東京都千代田区" type="text" />
                                                        </div>
                                                        <div>
                                                            <label
                                                                class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">郵便番号</label>
                                                            <input name="zipCode" th:value="${searchForm?.zipCode}"
                                                                class="form-input block w-full rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] text-gray-800 dark:text-white placeholder:text-gray-400 dark:placeholder:text-gray-500 focus:ring-primary focus:border-primary h-9 text-sm"
                                                                placeholder="例: 100-0005" type="text" />
                                                        </div>
                                                        <div class="md:col-span-2">
                                                            <label
                                                                class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">登録日</label>
                                                            <div class="flex items-center gap-2">
                                                                <input name="dateFrom"
                                                                    th:value="${searchForm?.dateFrom}"
                                                                    class="form-input block w-full rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] text-gray-800 dark:text-white focus:ring-primary focus:border-primary h-9 text-sm"
                                                                    type="date" />
                                                                <span class="text-gray-500 dark:text-gray-400">〜</span>
                                                                <input name="dateTo" th:value="${searchForm?.dateTo}"
                                                                    class="form-input block w-full rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] text-gray-800 dark:text-white focus:ring-primary focus:border-primary h-9 text-sm"
                                                                    type="date" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex justify-end gap-2 mt-4">
                                                        <!-- クリアボタン: 検索条件なしで再検索 -->
                                                        <a th:href="@{/companies}"
                                                            class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-9 px-4 bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                                            クリア
                                                        </a>
                                                        <!-- 検索ボタン: フォームsubmit -->
                                                        <button type="submit"
                                                            class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-9 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">
                                                            検索
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                        </form>
                        <div class="relative">
                            <button type="button" id="settingsButton"
                                class="flex h-10 w-10 cursor-pointer items-center justify-center overflow-hidden rounded-lg bg-gray-200 dark:bg-[#283039] text-gray-800 dark:text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#3b4754] transition-colors">
                                <span class="material-symbols-outlined text-xl">settings</span>
                            </button>
                            <div id="settingsDropdown"
                                class="hidden absolute top-full right-0 mt-2 w-64 bg-white dark:bg-[#283039] border border-gray-300 dark:border-[#3b4754] rounded-lg shadow-xl z-20">
                                <div class="p-4 border-b border-gray-200 dark:border-[#3b4754]">
                                    <h3 class="text-sm font-bold text-gray-800 dark:text-white text-left">
                                        列の表示設定
                                    </h3>
                                </div>
                                <div class="p-4 space-y-3 text-sm text-left" id="columnSettings">
                                    <label
                                        class="flex items-center gap-2 cursor-pointer text-gray-500 dark:text-gray-400">
                                        <input type="checkbox" data-col="companyName" checked disabled
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 cursor-not-allowed" />
                                        <span class="opacity-75">企業名</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-2 cursor-pointer text-gray-500 dark:text-gray-400">
                                        <input type="checkbox" data-col="address" checked disabled
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 cursor-not-allowed" />
                                        <span class="opacity-75">住所</span>
                                    </label>
                                    <label
                                        class="flex items-center gap-2 cursor-pointer text-gray-500 dark:text-gray-400">
                                        <input type="checkbox" data-col="zipCode" checked disabled
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600 cursor-not-allowed" />
                                        <span class="opacity-75">郵便番号</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer text-gray-800 dark:text-white">
                                        <input type="checkbox" data-col="companyId" checked
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600" />
                                        <span>企業ID</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer text-gray-800 dark:text-white">
                                        <input type="checkbox" data-col="registrationDate" checked
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600" />
                                        <span>登録日</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer text-gray-800 dark:text-white">
                                        <input type="checkbox" data-col="remarks" checked
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600" />
                                        <span>備考</span>
                                    </label>
                                </div>
                                <!-- <div
                                    class="flex justify-end gap-2 p-3 bg-gray-50 dark:bg-[#1c2127] border-t border-gray-200 dark:border-[#3b4754]">
                                    <button
                                        class="flex min-w-[70px] cursor-pointer items-center justify-center overflow-hidden rounded-md h-8 px-3 bg-gray-200 dark:bg-[#3b4754] text-gray-800 dark:text-white text-xs font-bold leading-normal tracking-[0.015em] hover:bg-gray-300 dark:hover:bg-[#4a5867] transition-colors">キャンセル</button>
                                    <button
                                        class="flex min-w-[70px] cursor-pointer items-center justify-center overflow-hidden rounded-md h-8 px-3 bg-primary text-white text-xs font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors">適用</button>
                                </div> -->
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="flex overflow-hidden rounded-lg border border-gray-300 dark:border-[#3b4754] bg-white dark:bg-background-dark flex-col flex-1">
                    <div class="overflow-y-auto flex-1">
                        <table class="w-full min-w-[1200px] text-sm">
                            <thead class="sticky top-0 z-10">
                                <tr class="bg-gray-50 dark:bg-[#1c2127]">
                                    <th
                                        class="select-checkbox-col hidden px-4 py-2.5 text-center w-[40px] font-medium leading-normal">
                                        <input type="checkbox" id="selectAllCheckbox"
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600" />
                                    </th>
                                    <th
                                        class="px-4 py-2.5 text-center text-gray-600 dark:text-white w-[60px] font-medium leading-normal">
                                        No.
                                    </th>
                                    <th data-col="companyId" data-sort-type="number"
                                        class="px-4 py-2.5 text-left text-gray-600 dark:text-white w-[100px] font-medium leading-normal group cursor-pointer">
                                        <div class="flex items-center gap-2">企業ID <span
                                                class="sort-icon text-xs text-gray-400 group-hover:text-gray-600 dark:text-gray-400">↕</span>
                                        </div>
                                    </th>
                                    <th data-col="companyName" data-sort-type="text"
                                        class="px-4 py-2.5 text-left text-gray-600 dark:text-white w-[220px] font-medium leading-normal group cursor-pointer">
                                        <div class="flex items-center gap-2">企業名 <span
                                                class="sort-icon text-xs text-gray-400 group-hover:text-gray-600 dark:text-gray-400">↕</span>
                                        </div>
                                    </th>
                                    <th data-col="address" data-sort-type="text"
                                        class="px-4 py-2.5 text-left text-gray-600 dark:text-white w-[250px] font-medium leading-normal group cursor-pointer">
                                        <div class="flex items-center gap-2">住所 <span
                                                class="sort-icon text-xs text-gray-400 group-hover:text-gray-600 dark:text-gray-400">↕</span>
                                        </div>
                                    </th>
                                    <th data-col="zipCode" data-sort-type="text"
                                        class="px-4 py-2.5 text-left text-gray-600 dark:text-white w-[120px] font-medium leading-normal group cursor-pointer">
                                        <div class="flex items-center gap-2">郵便番号 <span
                                                class="sort-icon text-xs text-gray-400 group-hover:text-gray-600 dark:text-gray-400">↕</span>
                                        </div>
                                    </th>
                                    <th data-col="registrationDate" data-sort-type="date"
                                        class="px-4 py-2.5 text-left text-gray-600 dark:text-white w-[140px] font-medium leading-normal group cursor-pointer">
                                        <div class="flex items-center gap-2">登録日 <span
                                                class="sort-icon text-xs text-gray-400 group-hover:text-gray-600 dark:text-gray-400">↕</span>
                                        </div>
                                    </th>
                                    <th data-col="remarks" data-sort-type="text"
                                        class="px-4 py-2.5 text-left text-gray-600 dark:text-white min-w-[200px] font-medium leading-normal group cursor-pointer">
                                        <div class="flex items-center gap-2">備考 <span
                                                class="sort-icon text-xs text-gray-400 group-hover:text-gray-600 dark:text-gray-400">↕</span>
                                        </div>
                                    </th>
                                    <th data-col="actions"
                                        class="px-4 py-2.5 text-center text-gray-600 dark:text-white w-[120px] font-medium leading-normal">
                                        操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:if="${page.totalElements == 0}" class="js-empty-row">
                                    <td colspan="9"
                                        class="px-4 py-10 text-center text-gray-500 dark:text-gray-400">
                                        該当データがありません
                                    </td>
                                </tr>
                                <tr th:each="company, iterStat : ${companies}"
                                    class="border-t border-t-gray-200 dark:border-t-[#3b4754] hover:bg-gray-50 dark:hover:bg-[#1c2127]/50">
                                    <td class="select-checkbox-col hidden px-4 py-2 text-center">
                                        <input type="checkbox" name="rowCheckbox" th:value="${company.companyId}"
                                            class="form-checkbox rounded text-primary focus:ring-primary/50 bg-gray-200 dark:bg-gray-700 border-gray-300 dark:border-gray-600" />
                                    </td>
                                    <td
                                        class="px-4 py-2 text-center text-gray-400 dark:text-gray-500 font-normal leading-normal">
                                        [[${(page.number * page.size) + iterStat.count}]]
                                    </td>
                                    <td data-col="companyId"
                                        class="px-4 py-2 text-gray-500 dark:text-[#9dabb9] font-normal leading-normal">
                                        [[${company.companyId}]]</td>
                                    <td data-col="companyName"
                                        class="px-4 py-2 text-gray-800 dark:text-white font-normal leading-normal">
                                        [[${company.companyName}]]</td>
                                    <td data-col="address"
                                        class="px-4 py-2 text-gray-500 dark:text-[#9dabb9] font-normal leading-normal">
                                        [[${company.address}]]</td>
                                    <td data-col="zipCode"
                                        class="px-4 py-2 text-gray-500 dark:text-[#9dabb9] font-normal leading-normal">
                                        [[${company.zipCode}]]</td>
                                    <td data-col="registrationDate"
                                        class="px-4 py-2 text-gray-500 dark:text-[#9dabb9] font-normal leading-normal">
                                        [[${company.registrationDate}]]</td>
                                    <td data-col="remarks"
                                        class="px-4 py-2 text-gray-500 dark:text-[#9dabb9] font-normal leading-normal truncate max-w-xs">
                                        [[${company.remarks}]]</td>
                                    <td data-col="actions" class="px-4 py-2 w-60 text-center">
                                        <div class="flex justify-center gap-2">
                                            <a data-edit-link
                                                th:href="@{/companies/edit/{id}(id=${company.companyId})}">
                                                <button
                                                    class="h-8 w-8 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                                                    <span class="material-symbols-outlined text-xl">edit</span>
                                                </button>
                                            </a>
                                            <button type="button" th:data-id="${company.companyId}"
                                                th:data-name="${company.companyName}" onclick="deleteCompany(this)"
                                                class="h-8 w-8 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                                                <span class="material-symbols-outlined text-xl">delete</span>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div
                        class="flex flex-wrap items-center justify-between gap-4 p-3 border-t border-gray-200 dark:border-[#3b4754]">
                        <!-- 表示件数セレクタ -->
                        <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                            <span>表示件数:</span>
                            <form th:action="@{/companies}" method="get" id="pageSizeForm">
                                <!-- 検索条件を隠しフィールドで保持 -->
                                <input type="hidden" name="keyword" th:value="${searchForm?.keyword}" />
                                <input type="hidden" name="companyId" th:value="${searchForm?.companyId}" />
                                <input type="hidden" name="companyName" th:value="${searchForm?.companyName}" />
                                <input type="hidden" name="address" th:value="${searchForm?.address}" />
                                <input type="hidden" name="zipCode" th:value="${searchForm?.zipCode}" />
                                <input type="hidden" name="dateFrom" th:value="${searchForm?.dateFrom}" />
                                <input type="hidden" name="dateTo" th:value="${searchForm?.dateTo}" />
                                <select name="size" onchange="document.getElementById('pageSizeForm').submit()"
                                    class="form-select rounded-md bg-white dark:bg-[#283039] border-gray-300 dark:border-[#3b4754] focus:ring-primary focus:border-primary h-8 py-0 pl-2 pr-7 text-sm">
                                    <option value="5" th:selected="${page.size == 5}">5</option>
                                    <option value="10" th:selected="${page.size == 10}">10</option>
                                    <option value="20" th:selected="${page.size == 20}">20</option>
                                    <option value="50" th:selected="${page.size == 50}">50</option>
                                    <option value="100" th:selected="${page.size == 100}">100</option>
                                </select>
                            </form>
                        </div>
                        <!-- ページ情報とナビゲーション -->
                        <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                            <span
                                th:text="|${page.number * page.size + 1}-${page.number * page.size + page.numberOfElements} of ${page.totalElements}件|">1-10
                                of 123件</span>
                            <div class="flex gap-1">
                                <!-- 最初のページへ -->
                                <a th:href="@{/companies(page=0, size=${page.size}, keyword=${searchForm?.keyword}, companyId=${searchForm?.companyId}, companyName=${searchForm?.companyName}, address=${searchForm?.address}, zipCode=${searchForm?.zipCode}, dateFrom=${searchForm?.dateFrom}, dateTo=${searchForm?.dateTo})}"
                                    th:classappend="${page.first or page.totalElements == 0} ? 'pointer-events-none opacity-50' : ''"
                                    class="h-8 w-8 rounded flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <span class="material-symbols-outlined text-xl">first_page</span>
                                </a>
                                <!-- 前のページへ -->
                                <a th:href="@{/companies(page=${page.number - 1}, size=${page.size}, keyword=${searchForm?.keyword}, companyId=${searchForm?.companyId}, companyName=${searchForm?.companyName}, address=${searchForm?.address}, zipCode=${searchForm?.zipCode}, dateFrom=${searchForm?.dateFrom}, dateTo=${searchForm?.dateTo})}"
                                    th:classappend="${page.first or page.totalElements == 0} ? 'pointer-events-none opacity-50' : ''"
                                    class="h-8 w-8 rounded flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <span class="material-symbols-outlined text-xl">chevron_left</span>
                                </a>
                                <!-- 次のページへ -->
                                <a th:href="@{/companies(page=${page.number + 1}, size=${page.size}, keyword=${searchForm?.keyword}, companyId=${searchForm?.companyId}, companyName=${searchForm?.companyName}, address=${searchForm?.address}, zipCode=${searchForm?.zipCode}, dateFrom=${searchForm?.dateFrom}, dateTo=${searchForm?.dateTo})}"
                                    th:classappend="${page.last or page.totalElements == 0} ? 'pointer-events-none opacity-50' : ''"
                                    class="h-8 w-8 rounded flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <span class="material-symbols-outlined text-xl">chevron_right</span>
                                </a>
                                <!-- 最後のページへ -->
                                <a th:href="@{/companies(page=${page.totalPages - 1}, size=${page.size}, keyword=${searchForm?.keyword}, companyId=${searchForm?.companyId}, companyName=${searchForm?.companyName}, address=${searchForm?.address}, zipCode=${searchForm?.zipCode}, dateFrom=${searchForm?.dateFrom}, dateTo=${searchForm?.dateTo})}"
                                    th:classappend="${page.last or page.totalElements == 0} ? 'pointer-events-none opacity-50' : ''"
                                    class="h-8 w-8 rounded flex items-center justify-center hover:bg-gray-200 dark:hover:bg-gray-700">
                                    <span class="material-symbols-outlined text-xl">last_page</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true">
            <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                <!-- Background overlay -->
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                    onclick="document.getElementById('exportModal').classList.add('hidden')"></div>

                <!-- Modal panel -->
                <div
                    class="inline-block align-bottom bg-white dark:bg-[#1c2127] rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                    <form id="exportForm" th:action="@{/companies/export}" method="post">
                        <!-- Hidden fields for search params (copied via JS) -->
                        <input type="hidden" name="keyword" />
                        <input type="hidden" name="companyId" />
                        <input type="hidden" name="companyName" />
                        <input type="hidden" name="address" />
                        <input type="hidden" name="zipCode" />
                        <input type="hidden" name="dateFrom" />
                        <input type="hidden" name="dateTo" />
                        <!-- Selected IDs -->
                        <input type="hidden" name="selectedIds" id="exportSelectedIds" />

                        <div class="px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modal-title">
                                エクスポート設定
                            </h3>
                            <div class="mt-4 space-y-4">
                                <!-- Output Scope -->
                                <div>
                                    <label
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">対象データ</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" name="scope" value="SEARCH" checked
                                                class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">現在の検索結果 <span
                                                    id="searchCountStr" class="text-xs text-gray-500"></span></span>
                                        </label>
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" name="scope" value="ALL"
                                                class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">全データ</span>
                                        </label>
                                        <label class="flex items-center space-x-3 cursor-pointer">
                                            <input type="radio" name="scope" value="SELECTION" id="scopeSelection"
                                                disabled
                                                class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                            <span class="text-gray-700 dark:text-gray-300"
                                                id="selectionLabel">選択したデータのみ</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Columns -->
                                <div>
                                    <label
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">出力カラム設定</label>
                                    <div class="grid grid-cols-2 gap-2 text-sm">
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="columns" value="companyId" checked
                                                class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">企業ID</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="columns" value="companyName" checked
                                                class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">企業名</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="columns" value="address" checked
                                                class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">住所</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="columns" value="zipCode" checked
                                                class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">郵便番号</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="columns" value="registrationDate" checked
                                                class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">登録日</span>
                                        </label>
                                        <label class="flex items-center space-x-2">
                                            <input type="checkbox" name="columns" value="remarks" checked
                                                class="form-checkbox h-4 w-4 text-primary rounded border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                            <span class="text-gray-700 dark:text-gray-300">備考</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Sort Settings -->
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label
                                            class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">並び替え基準</label>
                                        <select name="sortBy" id="exportSortBy"
                                            class="form-select block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white h-9 text-sm">
                                            <option value="companyId">企業ID</option>
                                            <option value="companyName">企業名</option>
                                            <option value="address">住所</option>
                                            <option value="zipCode">郵便番号</option>
                                            <option value="registrationDate">登録日</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label
                                            class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">順序</label>
                                        <div class="flex items-center h-9 space-x-4">
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="radio" name="sortOrder" value="ASC" checked
                                                    class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                                <span class="text-gray-700 dark:text-gray-300 text-sm">昇順</span>
                                            </label>
                                            <label class="flex items-center space-x-2 cursor-pointer">
                                                <input type="radio" name="sortOrder" value="DESC"
                                                    class="form-radio h-4 w-4 text-primary focus:ring-primary border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700">
                                                <span class="text-gray-700 dark:text-gray-300 text-sm">降順</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Filename -->
                                <div>
                                    <label
                                        class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">ファイル名</label>
                                    <div class="flex items-center">
                                        <input type="text" name="fileName" value="companies"
                                            class="form-input block w-full rounded-l-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-800 dark:text-white h-9 sm:text-sm">
                                        <span
                                            class="inline-flex items-center px-3 h-9 rounded-r-md border border-l-0 border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-800 text-gray-500 dark:text-gray-400 text-sm">
                                            .xlsx
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gray-50 dark:bg-[#283039] px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button type="submit"
                                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
                                ダウンロード
                            </button>
                            <button type="button"
                                onclick="document.getElementById('exportModal').classList.add('hidden')"
                                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                キャンセル
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <script>
                (function () {
                    const STORAGE_KEY = 'companyListVisibleColumns';

                    // デフォルトの表示設定（全て表示）
                    const defaultSettings = {
                        companyId: false,
                        companyName: true,
                        address: true,
                        zipCode: true,
                        registrationDate: true,
                        remarks: true
                    };

                    // localStorageから設定を読み込む
                    function loadSettings() {
                        try {
                            const saved = localStorage.getItem(STORAGE_KEY);
                            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
                        } catch (e) {
                            return defaultSettings;
                        }
                    }

                    // localStorageに設定を保存
                    function saveSettings(settings) {
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
                    }

                    // 列の表示/非表示を適用（テーブル内のth, tdのみ対象）
                    function applyColumnVisibility(settings) {
                        Object.keys(settings).forEach(col => {
                            const cells = document.querySelectorAll(`table [data-col="${col}"]`);
                            cells.forEach(cell => {
                                cell.style.display = settings[col] ? '' : 'none';
                            });
                        });
                    }

                    // チェックボックスの状態を設定に反映
                    function syncCheckboxes(settings) {
                        const checkboxes = document.querySelectorAll('#columnSettings input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            const col = cb.dataset.col;
                            if (col && settings[col] !== undefined) {
                                cb.checked = settings[col];
                            }
                        });
                    }

                    // 初期化
                    function init() {
                        const settings = loadSettings();
                        syncCheckboxes(settings);
                        applyColumnVisibility(settings);

                        // チェックボックスの変更イベント（リアルタイム反映）
                        const checkboxes = document.querySelectorAll('#columnSettings input[type="checkbox"]:not(:disabled)');
                        checkboxes.forEach(cb => {
                            cb.addEventListener('change', function () {
                                const col = this.dataset.col;
                                settings[col] = this.checked;
                                applyColumnVisibility(settings);
                                saveSettings(settings);
                            });
                        });
                    }

                    // State Persistence Logic
                    (function () {
                        const currentUrl = window.location.href;
                        const lastUrl = sessionStorage.getItem('lastListUrl');

                        if (!window.location.search && lastUrl && lastUrl !== currentUrl) {
                            window.location.replace(lastUrl);
                            return;
                        }

                        sessionStorage.setItem('lastListUrl', currentUrl);
                    })();

                    // DOMContentLoaded後に実行
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', init);
                    } else {
                        init();
                    }

                    // 設定メニューの表示切り替え
                    const settingsButton = document.getElementById('settingsButton');
                    const settingsDropdown = document.getElementById('settingsDropdown');

                    if (settingsButton && settingsDropdown) {
                        settingsButton.addEventListener('click', function (e) {
                            e.stopPropagation();
                            settingsDropdown.classList.toggle('hidden');
                        });

                        // メニュー外クリックで閉じる
                        document.addEventListener('click', function (e) {
                            if (!settingsDropdown.contains(e.target) && !settingsButton.contains(e.target)) {
                                settingsDropdown.classList.add('hidden');
                            }
                        });

                        // メニュー内のクリックイベント伝播を止める（チェックボックス操作で閉じないようにするため）
                        settingsDropdown.addEventListener('click', function (e) {
                            e.stopPropagation();
                        });
                    }
                })();

            (function () {
                const lastUrl = sessionStorage.getItem('lastListUrl');
                if (!lastUrl) return;

                document.querySelectorAll('a[data-edit-link]').forEach(link => {
                    const linkUrl = new URL(link.getAttribute('href'), window.location.origin);
                    linkUrl.searchParams.set('returnUrl', lastUrl);
                    link.setAttribute('href', `${linkUrl.pathname}?${linkUrl.searchParams.toString()}`);
                });
            })();

            // Table Sort Logic
            (function () {
                const table = document.querySelector('table');
                const tbody = table ? table.querySelector('tbody') : null;
                const headers = table ? table.querySelectorAll('thead th[data-col]') : [];
                const state = { column: null, direction: 'asc' };

                if (!table || !tbody || headers.length === 0) return;

                function parseValue(value, type) {
                    if (type === 'number') {
                        const num = parseFloat(value.replace(/[^0-9.-]/g, ''));
                        return Number.isNaN(num) ? null : num;
                    }
                    if (type === 'date') {
                        const date = Date.parse(value);
                        return Number.isNaN(date) ? null : date;
                    }
                    return value.toLowerCase();
                }

                function updateIcons(activeCol, direction) {
                    headers.forEach(header => {
                        const icon = header.querySelector('.sort-icon');
                        if (!icon) return;
                        if (header.dataset.col === activeCol) {
                            icon.textContent = direction === 'asc' ? '↑' : '↓';
                        } else {
                            icon.textContent = '↕';
                        }
                    });
                }

                function sortRows(column, type, direction) {
                    const rows = Array.from(tbody.querySelectorAll('tr'))
                        .filter(row => !row.classList.contains('js-empty-row'));

                    rows.sort((a, b) => {
                        const aCell = a.querySelector(`[data-col="${column}"]`);
                        const bCell = b.querySelector(`[data-col="${column}"]`);
                        const aValue = parseValue(aCell ? aCell.textContent.trim() : '', type);
                        const bValue = parseValue(bCell ? bCell.textContent.trim() : '', type);

                        if (aValue === null && bValue === null) return 0;
                        if (aValue === null) return 1;
                        if (bValue === null) return -1;

                        if (aValue < bValue) return direction === 'asc' ? -1 : 1;
                        if (aValue > bValue) return direction === 'asc' ? 1 : -1;
                        return 0;
                    });

                    rows.forEach(row => tbody.appendChild(row));
                }

                headers.forEach(header => {
                    if (header.dataset.col === 'actions') return;
                    header.addEventListener('click', () => {
                        const column = header.dataset.col;
                        const type = header.dataset.sortType || 'text';
                        const isSame = state.column === column;
                        state.direction = isSame && state.direction === 'asc' ? 'desc' : 'asc';
                        state.column = column;
                        sortRows(column, type, state.direction);
                        updateIcons(column, state.direction);
                    });
                });
            })();

            // Export & Select Mode Logic
            (function () {
                const toggleBtn = document.getElementById('toggleSelectModeBtn');
                const exportBtn = document.getElementById('openExportModalBtn');
                const modal = document.getElementById('exportModal');
                const selectAllCb = document.getElementById('selectAllCheckbox');
                const rowCbs = document.getElementsByName('rowCheckbox');

                let isSelectMode = false;

                // Toggle Select Mode
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function () {
                        isSelectMode = !isSelectMode;
                        const cols = document.querySelectorAll('.select-checkbox-col');
                        cols.forEach(el => {
                            if (isSelectMode) el.classList.remove('hidden');
                            else el.classList.add('hidden');
                        });

                        // Icon change
                        const icon = toggleBtn.querySelector('.material-symbols-outlined');
                        if (isSelectMode) {
                            toggleBtn.classList.add('bg-primary', 'text-white');
                            toggleBtn.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-[#283039]', 'dark:text-white');
                            if (icon) icon.innerText = 'check_box';
                        } else {
                            toggleBtn.classList.remove('bg-primary', 'text-white');
                            toggleBtn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-[#283039]', 'dark:text-white');
                            if (icon) icon.innerText = 'check_box_outline_blank'; // or check_box
                        }
                    });
                }

                // Select All
                if (selectAllCb) {
                    selectAllCb.addEventListener('change', function () {
                        const checked = this.checked;
                        rowCbs.forEach(cb => cb.checked = checked);
                    });
                }

                // Open Modal logic
                if (exportBtn && modal) {
                    exportBtn.addEventListener('click', function () {
                        // 1. Copy Search Params
                        // Assuming the main search form inputs have unique names or we select them from the document
                        // Using document.getElementsByName to find source inputs (first one found usually main form)
                        const fields = ['keyword', 'companyId', 'companyName', 'address', 'zipCode', 'dateFrom', 'dateTo'];
                        const modalForm = document.getElementById('exportForm');

                        fields.forEach(name => {
                            const src = document.querySelector(`form:not(#exportForm) input[name="${name}"]`);
                            const dest = modalForm.querySelector(`input[name="${name}"]`);
                            if (src && dest) dest.value = src.value;
                        });

                        // 2. Identify Selected rows
                        const selectedIds = Array.from(rowCbs)
                            .filter(cb => cb.checked)
                            .map(cb => cb.value);

                        document.getElementById('exportSelectedIds').value = selectedIds.join(',');

                        // 2.5 Populate Search Count
                        const pageInfo = document.querySelector('.flex.items-center.gap-2.text-sm span');
                        if (pageInfo) {
                            const text = pageInfo.innerText;
                            // Extract total count, e.g. "1-10 of 123件" -> "123"
                            const match = text.match(/of\s+(\d+)件/);
                            if (match) {
                                const searchCountStr = document.getElementById('searchCountStr');
                                if (searchCountStr) searchCountStr.innerText = `(${match[1]}件)`;
                            } else if (text.includes('件')) {
                                // Single page case e.g. "5件"
                                const searchCountStr = document.getElementById('searchCountStr');
                                if (searchCountStr) searchCountStr.innerText = `(${text})`;
                            }
                        }

                        // 3. Setup Scope Radios
                        const scopeSelection = document.getElementById('scopeSelection');
                        const selectionLabel = document.getElementById('selectionLabel');

                        if (selectedIds.length > 0) {
                            scopeSelection.disabled = false;
                            scopeSelection.checked = true; // Default to selection if any selected
                            selectionLabel.textContent = `選択したデータのみ (${selectedIds.length}件)`;
                            selectionLabel.classList.remove('opacity-50');
                        } else {
                            scopeSelection.disabled = true;
                            selectionLabel.textContent = `選択したデータのみ (0件)`;
                            selectionLabel.classList.add('opacity-50');
                            // Fallback to Search or All
                            // Default to Search usually
                            document.querySelector('input[name="scope"][value="SEARCH"]').checked = true;
                        }

                        // 4. Initialize Sort based on current URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const currentSort = urlParams.get('sort'); // e.g., "companyName,desc"
                        if (currentSort) {
                            const parts = currentSort.split(',');
                            const sortBy = parts[0]; // field name
                            const sortOrder = parts.length > 1 ? parts[1].toUpperCase() : 'ASC';

                            const sortSelect = document.getElementById('exportSortBy');
                            if (sortSelect && sortSelect.querySelector(`option[value="${sortBy}"]`)) {
                                sortSelect.value = sortBy;
                            }

                            const orderRadio = document.querySelector(`input[name="sortOrder"][value="${sortOrder}"]`);
                            if (orderRadio) orderRadio.checked = true;
                        }

                        // Show Modal
                        modal.classList.remove('hidden');
                    });
                }
            })();
            // --- Deletion Toast with Undo Logic ---
            function deleteCompany(btn) {
                const id = btn.dataset.id;
                const name = btn.dataset.name;
                const row = btn.closest('tr');

                const csrfMeta = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

                const headers = {};
                if (csrfMeta && csrfHeaderMeta) {
                    headers[csrfHeaderMeta.content] = csrfMeta.content;
                }

                // Perform soft-delete via AJAX
                fetch(`/api/companies/delete/${id}`, {
                    method: 'POST',
                    headers: headers
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // Immediately hide row
                            row.style.transition = 'all 0.3s ease';
                            row.style.opacity = '0';
                            setTimeout(() => {
                                row.style.display = 'none';
                            }, 300);

                            showToast(`${name} を削除しました`, 'success', () => {
                                undoDelete(id, row);
                            });
                        } else {
                            showToast('削除に失敗しました: ' + data.message, 'error');
                        }
                    })
                    .catch(err => {
                        console.error('Error deleting company:', err);
                        showToast('エラーが発生しました', 'error');
                    });
            }
            function undoDelete(id, row) {
                const csrfMeta = document.querySelector('meta[name="_csrf"]');
                const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');

                const headers = {};
                if (csrfMeta && csrfHeaderMeta) {
                    headers[csrfHeaderMeta.content] = csrfMeta.content;
                }

                fetch(`/api/companies/restore/${id}`, {
                    method: 'POST',
                    headers: headers
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            // Restore row
                            row.style.display = '';
                            setTimeout(() => {
                                row.style.opacity = '1';
                            }, 10);
                            showToast('復元しました', 'success');
                        } else {
                            showToast('復元に失敗しました: ' + data.message, 'error');
                        }
                    })
                    .catch(err => {
                        console.error('Error restoring company:', err);
                        showToast('エラーが発生しました', 'error');
                    });
            }
            function showToast(message, type = 'list', undoAction = null) {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast';

                let icon = 'check_circle';
                let iconColor = 'text-green-500';
                if (type === 'error') {
                    icon = 'error';
                    iconColor = 'text-red-500';
                }

                toast.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="material-symbols-outlined ${iconColor}">${icon}</span>
                    <span class="text-sm font-medium">${message}</span>
                </div>
                <div class="flex items-center gap-3">
                    ${undoAction ? '<button class="toast-undo-btn">元に戻す</button>' : ''}
                    <button class="toast-close-btn">
                        <span class="material-symbols-outlined text-base">close</span>
                    </button>
                </div>
            `;

                if (undoAction) {
                    const undoBtn = toast.querySelector('.toast-undo-btn');
                    undoBtn.onclick = () => {
                        undoAction();
                        hideToast(toast);
                    };
                }

                const closeBtn = toast.querySelector('.toast-close-btn');
                closeBtn.onclick = () => {
                    hideToast(toast);
                };

                container.appendChild(toast);

                // Auto-hide after 10 seconds
                const timerId = setTimeout(() => {
                    hideToast(toast);
                }, 10000);

                // Store timerId if needed to cancel it
                toast.dataset.timerId = timerId;
            }

            function hideToast(toast) {
                if (toast.classList.contains('hiding')) return;

                clearTimeout(toast.dataset.timerId);
                toast.classList.add('hiding');

                toast.addEventListener('animationend', () => {
                    toast.remove();
                });
            }

            // --- Handle Server-side Messages via Toast ---
            window.addEventListener('load', () => {
                const successMsg = "[[${successMessage}]]";
                const errorMsg = "[[${errorMessage}]]";

                console.log('SuccessMsg:', successMsg);
                console.log('ErrorMsg:', errorMsg);

                if (successMsg && successMsg !== "null" && successMsg !== "") {
                    showToast(successMsg, 'success');
                }
                if (errorMsg && errorMsg !== "null" && errorMsg !== "") {
                    showToast(errorMsg, 'error');
                }
            });
        </script>
        <!-- Toast Container -->
        <div id="toast-container"></div>

</body>

</html>
